# Migration Guide: v0.6.x ‚Üí v1.0.0

## Overview

v1.0.0 introduces a **unified API** that simplifies CLI testing with automatic mode detection and vitest config integration.

## Key Changes

### ‚úÖ What's New
- Single `runCitty()` function (replaces `runLocalCitty` and cleanroom setup)
- Auto-detection of local vs cleanroom mode
- Vitest config integration (`test.citty` section)
- Simplified Scenario DSL: `.step(name, args)` instead of `.step(name).run(args)`
- Automatic cleanroom lifecycle (no manual setup/teardown)

### ‚ö†Ô∏è Breaking Changes
1. **Runner API Changed**: Use `runCitty()` instead of separate functions
2. **Scenario DSL Simplified**: `.run()` method removed
3. **Config-First Approach**: Configure in `vitest.config.js` instead of every test
4. **Automatic Cleanroom**: No manual `setupCleanroom()` / `teardownCleanroom()`

---

## Migration Steps

### 1. Update vitest.config.js

**Create or update your vitest config:**

```javascript
// vitest.config.js
export default {
  test: {
    citty: {
      cliPath: './src/cli.mjs',  // Your CLI entry point
      cleanroom: {
        enabled: false  // true for Docker isolation
      }
    }
  }
}
```

### 2. Update Test Code

#### Option A: Use New Unified API (Recommended)

**Before (v0.6.x):**
```javascript
import { runLocalCitty } from 'citty-test-utils'

const result = await runLocalCitty({
  args: ['--help'],
  cliPath: './src/cli.mjs',
  cwd: process.cwd()
})
```

**After (v1.0.0):**
```javascript
import { runCitty } from 'citty-test-utils'

// Config comes from vitest.config.js automatically!
const result = await runCitty(['--help'])
```

#### Option B: Keep Deprecated API (Temporary)

```javascript
// Old imports still work but are deprecated
import { runLocalCitty } from 'citty-test-utils'

// Your old code works unchanged
const result = await runLocalCitty({
  args: ['--help'],
  cliPath: './src/cli.mjs'
})
```

### 3. Update Scenario DSL

**Before (v0.6.x):**
```javascript
await scenario('Test')
  .step('Help').run('--help').expectSuccess()
  .step('Build').run(['build', '--prod']).expectSuccess()
  .execute('local')
```

**After (v1.0.0):**
```javascript
await scenario('Test')
  .step('Help', '--help').expectSuccess()
  .step('Build', ['build', '--prod']).expectSuccess()
  .execute()  // Auto-detects mode from config
```

### 4. Update Cleanroom Tests

**Before (v0.6.x):**
```javascript
import { setupCleanroom, teardownCleanroom } from 'citty-test-utils'

beforeAll(async () => {
  await setupCleanroom({ rootDir: '.' })
})

afterAll(async () => {
  await teardownCleanroom()
})

it('runs in cleanroom', async () => {
  const result = await runCitty(['--version'])
  result.expectSuccess()
})
```

**After (v1.0.0):**
```javascript
import { runCitty } from 'citty-test-utils'

// No setup/teardown needed! Just configure vitest.config.js
// with cleanroom.enabled = true

it('runs in cleanroom', async () => {
  const result = await runCitty(['--version'])
  result.expectSuccess()
})
```

Or override per-test:
```javascript
it('force cleanroom', async () => {
  const result = await runCitty(['--version'], {
    cleanroom: { enabled: true }
  })
  result.expectSuccess()
})
```

---

## Complete Example

### Before (v0.6.x)

```javascript
// test/cli.test.js
import { describe, it, beforeAll, afterAll } from 'vitest'
import { runLocalCitty, setupCleanroom, teardownCleanroom } from 'citty-test-utils'

describe('Local tests', () => {
  it('runs help', async () => {
    const result = await runLocalCitty({
      args: ['--help'],
      cliPath: './src/cli.mjs',
      cwd: process.cwd()
    })
    result.expectSuccess()
  })
})

describe('Cleanroom tests', () => {
  beforeAll(async () => {
    await setupCleanroom({ rootDir: '.' })
  })

  afterAll(async () => {
    await teardownCleanroom()
  })

  it('runs isolated', async () => {
    const result = await runCitty(['--version'])
    result.expectSuccess()
  })
})
```

### After (v1.0.0)

```javascript
// vitest.config.js
export default {
  test: {
    citty: {
      cliPath: './src/cli.mjs',
      cleanroom: { enabled: false }  // Set to true for Docker
    }
  }
}

// test/cli.test.js
import { describe, it } from 'vitest'
import { runCitty } from 'citty-test-utils'

describe('Local tests', () => {
  it('runs help', async () => {
    const result = await runCitty(['--help'])
    result.expectSuccess()
  })
})

describe('Cleanroom tests', () => {
  it('runs isolated', async () => {
    // Override config for this specific test
    const result = await runCitty(['--version'], {
      cleanroom: { enabled: true }
    })
    result.expectSuccess()
  })
})
```

---

## API Reference

### runCitty(args, options?)

**Signature:**
```typescript
function runCitty(
  args: string[],
  options?: {
    cliPath?: string
    cwd?: string
    env?: Record<string, string>
    timeout?: number
    cleanroom?: {
      enabled?: boolean
      image?: string
      timeout?: number
    }
  }
): Promise<Result>
```

**Config Hierarchy:**
1. `options` parameter (highest priority)
2. `vitest.config.js` citty section
3. Environment variables (`TEST_CLI_PATH`, `TEST_CWD`)
4. Defaults

**Auto-Detection:**
- Checks `options.cleanroom.enabled` ‚Üí cleanroom mode
- Checks `vitest.config` ‚Üí uses config
- Defaults to local mode

### scenario(name)

**Signature:**
```typescript
function scenario(name: string): ScenarioBuilder

interface ScenarioBuilder {
  step(name: string, args: string | string[], options?: object): this
  expectSuccess(): this
  expectFailure(): this
  expectExit(code: number): this
  expectOutput(pattern: string | RegExp): this
  execute(): Promise<void>
}
```

**Changes:**
- `.step(name, args)` combines step declaration with args
- `.run()` method removed
- `.execute()` with no mode parameter (auto-detects)

---

## Deprecation Timeline

| Version | Status | Notes |
|---------|--------|-------|
| v0.6.x API | Deprecated but works | Will be removed in v2.0.0 |
| v1.0.0 API | Current | Recommended for all new code |
| v2.0.0 (future) | v0.6.x removed | v1.0.0 API only |

---

## Troubleshooting

### "Cannot find module" errors

**Problem:** Old imports don't work
```javascript
import { runLocal } from 'citty-test-utils'  // ‚ùå Not exported
```

**Solution:** Use new imports
```javascript
import { runCitty } from 'citty-test-utils'  // ‚úÖ Works
```

### "CLI path not configured"

**Problem:** Tests fail with missing cliPath

**Solution:** Add to vitest.config.js
```javascript
export default {
  test: {
    citty: {
      cliPath: './src/cli.mjs'  // Required!
    }
  }
}
```

### "Cleanroom not working"

**Problem:** Tests run locally instead of Docker

**Solution:** Enable in config or options
```javascript
// vitest.config.js
export default {
  test: {
    citty: {
      cleanroom: { enabled: true }
    }
  }
}

// OR per-test
const result = await runCitty(['test'], {
  cleanroom: { enabled: true }
})
```

---

## Support

- **Issues**: https://github.com/seanchatmangpt/citty-test-utils/issues
- **Docs**: https://github.com/seanchatmangpt/citty-test-utils#readme
- **Changelog**: See CHANGELOG.md

---

**Need Help?** Open an issue with:
1. Your v0.6.x code
2. Error message
3. What you've tried

We'll help you migrate! üöÄ
